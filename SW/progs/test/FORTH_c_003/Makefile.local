include Make.color

# Recipe R_need_target_update {{{
R_need_target_update = \
	if cmp -s $@ $@.tmp &>/dev/null $(FORCE_THIS) ; then \
		rm -f $@.tmp; \
		echo -e "$@ - is OK"; \
	else \
		mv $@.tmp $@; \
		echo -e "$(COLORS)$(BRIGHTCYAN);$(BG_BLUE)m$@$(COLORS)$(RESET)m - updated"; \
	fi
# }}}

CFLAGS += -g
INC_FILES := $(wildcard words/*/*)
OBJS += $(BUILD)/C2forth.o
$(BUILD)/FORTH_c_003.o: TCB_offsets.c
$(BUILD)/FORTH_c_003.o: TCB_offsets.inc words/all_words.S $(INC_FILES)
TCB_offsets.inc: TCB_offsets.c
	avr-gcc -mmcu=atmega2560 -S TCB_offsets.c -o TCB_offsets.tmp
	grep "\.equ" TCB_offsets.tmp >$@
	rm TCB_offsets.tmp


.PHONY: FORCE

FORCE:
words/all_words.S: $(INC_FILES) TCB_offsets.inc Makefile Makefile.local FORCE
	@echo -e "; DO NOT EDIT\n; Autogenerated file\n" >$@.tmp
	@for f in $(INC_FILES); do \
		echo "#include \"../$$f\"" >> $@.tmp; \
	done
	@$(R_need_target_update)
	@for i in 1 2 3 4 5 6 7 8 9; do echo "#";done

$(BUILD)/all_words.o: words/all_words.S $(INC_FILES)  | $(BUILD)/
	$(CC) $(ASFLAGS) -c $< -o $@
	-$(OBJCOPY) -O binary $@ $@.bin

