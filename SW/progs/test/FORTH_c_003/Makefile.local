include Make.color

# Recipe R_need_target_update {{{
R_need_target_update = \
	if cmp -s $@ $@.tmp &>/dev/null $(FORCE_THIS) ; then \
		rm -f $@.tmp; \
		echo -e "$@ - is OK"; \
	else \
		mv $@.tmp $@; \
		echo -e "$(COLORS)$(BRIGHTCYAN);$(BG_BLUE)m$@$(COLORS)$(RESET)m - updated"; \
	fi
# }}}

INC_FILES := $(wildcard words/*/*)
OBJS += $(BUILD)/C2forth.o
$(BUILD)/FORTH_c_003.o: user_offsets.c
$(BUILD)/primitives.o: user_offsets.inc words/all_words.S $(INC_FILES)
user_offsets.inc: user_offsets.c
	avr-gcc -mmcu=atmega2560 -S user_offsets.c -o user_offsets.tmp
	grep "\.equ" user_offsets.tmp >$@
	rm user_offsets.tmp


.PHONY: FORCE
FORCE:
words/all_words.S: $(INC_FILES) Makefile Makefile.local FORCE
	@echo "; DO NOT EDIT\n; Autogenerated file\n" >$@.tmp
	@for f in $(INC_FILES); do \
		echo "#include \"../$$f\"" >> $@.tmp; \
	done
	@$(R_need_target_update)

